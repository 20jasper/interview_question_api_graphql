
name: publish docs

on:
  workflow_call:
    secrets:
      GITHUB_PAT:
        description: Personal Access Token for Docs repo write access
        required: true

jobs:
  ci:
    timeout-minutes: 10
    name: publish docs 
    runs-on: ubuntu-latest 
    env: 
      BASE_URL: https://banki-api.up.railway.app
      GRAPHQL_ENDPOINT: ${{ github.env.BASE_URL }}/api/graphql
      TARGET_REPO_USER: 20jasper
      TARGET_REPO_NAME: interview_question_api_graphql_docs

    steps:
      - name: checkout api repo
        uses: actions/checkout@v3

      - name: checkout docs repo
        uses: actions/checkout@v3
        with: 
          repository: ${{ env.TARGET_REPO_USER }}/${{ env.TARGET_REPO_NAME }}
          path: ${{ env.TARGET_REPO_NAME }}
          token: ${{ secrets.GITHUB_PAT }}

      - name: Install Graphdoc CLI
        run: npm install -g @2fd/graphdoc
      - name: Generate GraphQL docs
        run: npx graphdoc -e https://banki-api.up.railway.app/api/graphql -o ./${{ env.TARGET_REPO_NAME }}/docs/graphql -f

      - name: Commit files
        working-directory: ./${{ env.TARGET_REPO_NAME }}
        # sets user as github actions, adds and commits files, then saves output
        # to `COMMIT_RESPONSE`
        run: |
          git config --local user.email github-actions@github.com
          git config --local user.name github-actions
          git add .
          echo "COMMIT_RESPONSE<<EOF" >> $GITHUB_ENV
          git commit -m "Updating graphql docs!"" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Push files
        working-directory: ./${{ env.TARGET_REPO_NAME }}
        # if remote is not up to date
        if: ${{ !contains(env.COMMIT_RESPONSE, 'Your branch is up to date') }}
        run: git push

